{% extends 'home_index.html' %}
{% load static %}
<!-- No es necesario si estamos haciendo un extends 
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Prueba</title>
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/home_index.css' %}">
</head>
</html> -->

<!-- Titulo de la pÃ¡gina-->
{% block title %}
Piwit - Home
{% endblock title %}

{% block content %}
{% block extra_css %}
{% csrf_token %}
<meta name="csrf-token" content="{{ csrf_token }}">
<link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock %}
<div id="page-content">
      <div class="st-home-contenedor st-home-body">
        <div class="st-home-cuadrante cuadrante1">+</div>
        <div class="st-home-cuadrante cuadrante2">+</div>
        <div class="st-home-cuadrante cuadrante3">+</div>
        <div class="st-home-cuadrante cuadrante4">+</div>
      </div>
    
        <!-- Pomodoro/Test, NOTA PARA MARTIN: Este boton podrias usar para poder testear el pomodoro-->
      <div id="pomodoroControl" class="d-flex flex-column justify-content-center align-items-center">


      <div class="d-flex flex-column justify-content-center align-items-center" style="font-size: 0.85rem;">
        <h8 class="mb-2">Sesiones</h8>

        <div class="d-flex align-items-center gap-1">
          <button 
            id="btnDown"
            class="btn btn-sm btn-outline-primary p-1">â–¼</button>

          <span id="sessionCount" class="mx-1">{{ sesiones_restantes|length }}</span>

          <button 
            id="btnUp"
            class="btn btn-sm btn-outline-primary p-1">â–²</button>
        </div>

        <div id="sessionList" class="mt-1 d-flex gap-1 flex-wrap">
          {% for s in sesiones_restantes %}
            <span class="badge bg-secondary py-1 px-2">{{ s }}m</span>
          {% endfor %}
        </div>
    </div>
        <script>
          
          document.addEventListener("DOMContentLoaded", () => {
         // Estado inicial (igual que tu lista en Python)
          let sesionesRestantes = [1, 1];

          const btnUp = document.getElementById("btnUp");
          const btnDown = document.getElementById("btnDown");
          const sessionCount = document.getElementById("sessionCount");

          // --- FunciÃ³n para actualizar la vista ---
          function actualizarVista() {
            sessionCount.textContent = sesionesRestantes.length;
            }

          // --- Obtener CSRF token de Django ---
          function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
              const cookies = document.cookie.split(";");
              for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + "=")) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
            }
          }
          return cookieValue;
        }

        // --- Enviar cambios al servidor ---
        async function actualizarServidor(url) {
          try {
            const response = await fetch(url, {
              method: "POST",
              headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": getCookie("csrftoken"),
              },
        });
        const data = await response.json();
        sesionesRestantes = data.sesiones;
        actualizarVista();
      } catch (error) {
        console.error("Error al actualizar:", error);
        }
      }

      // --- Aumentar sesiones ---
      btnUp.addEventListener("click", () => {
        if (sesionesRestantes.length < 4) {
          sesionesRestantes.push(1); // AÃ±ade una sesiÃ³n (1 min o unidad)
          actualizarVista();
          actualizarServidor("{% url 'aumentar_sesiones' %}");
      } else {
          alert("âš ï¸ No es recomendable hacer mÃ¡s de 4 sesiones");
      }
    });

      // --- Disminuir sesiones ---
      btnDown.addEventListener("click", () => {
        if (sesionesRestantes.length > 1) {
          sesionesRestantes.pop();
          actualizarVista();
          actualizarServidor("{% url 'disminuir_sesiones' %}");
      } else {
        alert("Debes tener al menos una sesiÃ³n.");
      }
    });
    document.body.addEventListener('htmx:configRequest', (event) => {
      const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
      event.detail.headers['X-CSRFToken'] = csrfToken;
  });

  // --- Inicializar ---
          actualizarVista();
      });


      </script>
</div>
<div id="pomodoroContainer" class="text-center">
  <div id="timerDisplay">00:00</div>
<button onclick="iniciarPomodoro()"
class="btn btn-sm pomodoro-btn">
          â–¶ Iniciar Pomodoro
        </button>

</div>
<script>
let sesiones = [1, 1]; // minutos
let descanso = 1; // minutos
let indice = 0;

function iniciarPomodoro() {
  if (indice < sesiones.length) {
    let duracion = sesiones[indice] * 60; // convertir a segundos
    temporizador(duracion, "Estudio", () => {
      temporizador(descanso * 60, "Descanso", () => {
        indice++;
        iniciarPomodoro();
      });
    });
  } else {
    alert("ðŸŽ‰ Â¡Ciclo completado!");
  }
}

function temporizador(segundos, tipo, callback) {
  let remaining = segundos;
  const display = document.getElementById("timerDisplay");

  const interval = setInterval(() => {
    let min = Math.floor(remaining / 60);
    let sec = remaining % 60;
    display.textContent = `${tipo}: ${min}:${sec.toString().padStart(2, "0")}`;
    remaining--;

    if (remaining < 0) {
      clearInterval(interval);
      if (callback) callback();
    }
  }, 1000);
}
</script>
<br>
<br>
PIWIT Alpha v.1.0.8   1-11-2025 - (C) MMXXV Todos los derechos reservados, PYTHONEROS DEVELOPING TEAM LLC. // U.T.F.S.M Departamento de Informatica<br>
REDISTRIBUTION FORBIDDEN<br>
</div>
{% endblock %}
